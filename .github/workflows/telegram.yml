name: üîî Notifica√ß√µes no Telegram

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, closed, synchronize]

jobs:
  notificar:
    runs-on: ubuntu-latest
    name: üö® Notificar Telegram

    steps:
      - name: üîÑ Clonar reposit√≥rio
        uses: actions/checkout@v4

      - name: üìã Listar arquivos alterados
        id: changes
        run: |
          ARCHIVES=$(git diff --name-only HEAD~1 HEAD | head -n 10 | sed ':a;N;$!ba;s/\n/\\n/g')
          echo "arquivos=$ARCHIVES" >> $GITHUB_OUTPUT

      - name: üß† Gerar mensagem
        id: mensagem
        run: |
          AUTOR=${{ github.actor }}
          EVENTO=${{ github.event_name }}
          BRANCH=${{ github.ref_name }}
          COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          MSG="üîî *$EVENTO* em *$BRANCH* por [$AUTOR](https://github.com/$AUTOR)%0A"
          MSG+="üì¶ [Ver commit]($COMMIT_URL)%0A"

          if [ -n "${{ steps.changes.outputs.arquivos }}" ]; then
            MSG+="üìù Arquivos modificados:%0A"
            MSG+="${{ steps.changes.outputs.arquivos }}%0A"
          fi

          echo "msg=$MSG" >> $GITHUB_OUTPUT

      - name: ‚úÖ Rodar testes
        id: testes
        continue-on-error: true
        run: npm test

      - name: üì≤ Notificar no Telegram
        run: |
          STATUS="‚úÖ *Testes passaram com sucesso!*"
          if [ ${{ steps.testes.outcome }} != "success" ]; then
            STATUS="‚ùå *Testes falharam!*"
          fi

          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d parse_mode=Markdown \
            -d text="${{ steps.mensagem.outputs.msg }}%0A$STATUS"